
var exploit = JSON.parse(exploitJSON).exploit;
var data = {};
var debug = false;

var series = function (exploit, callback) {
    if (exploit.length === 0) callback();
    var count = 0;
    var clientStorage = {};
    if (debug) console.log("START");
    var iterate = function () {
        if (debug) console.log("COUNT: " + count);
        if (debug) console.log("DATA: " + JSON.stringify(data));
        var code = funcs[count];
        var options = [];
        var keys = [];

        // get our options
        for (var i = 0;i < exploit[count].options.length;i++) {
            keys.push(exploit[count].options.key);
            if (debug) console.log("PUSHING VALUE: " + clientStorage[exploit[count].options[i].value]);
            if (/^clientStorage/.test(exploit[count].options[i].value)) {
                // Push the saved value
                options.push(clientStorage[exploit[count].options[i].value]);
            } else {
                options.push(exploit[count].options[i].value);
            }
        }

        // Push our series itterator callback onto the stack
        var cb = function (data) {
            if (data) {
                clientStorage['clientStorage.' + count] = data;
            }
            count++;
            if (count !== exploit.length) {
                if (debug) console.log("NEXT");
                iterate();
            } else {
                if (debug) console.log("END");
                callback();
            }
        };
        keys.push('callback');
        options.push(cb);

        // call our function, with provided args & callback
        code.apply(keys, options);
    };
    iterate();
};

series(exploit, function () {
    if (debug) console.log("DONE");
});
